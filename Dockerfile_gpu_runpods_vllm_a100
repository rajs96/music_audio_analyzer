FROM pytorch/pytorch:2.8.0-cuda12.4-cudnn9-runtime
# -----------------------------
# 0) Install SSH server + deps
# -----------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server \
    ffmpeg \
    ca-certificates \
    git \
    ninja-build \
    build-essential \
  && rm -rf /var/lib/apt/lists/*

# -----------------------------
# 1) SSH setup (required)
# -----------------------------
RUN mkdir -p /var/run/sshd \
    && mkdir -p /root/.ssh \
    && chmod 700 /root/.ssh

# Allow key-based root login (RunPod injects keys here)
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config \
    && sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# -----------------------------
# 2) Your app setup
# -----------------------------
WORKDIR /app

# Copy only requirements first (better layer caching)
COPY src/instrument_detect/instrument_detector/requirements.in /app/requirements.in
COPY src/instrument_detect/instrument_detector/requirements_vllm.in /app/requirements_vllm.in

# Install pip-tools, compile requirements (torch unpinned to keep base image version), then install
RUN pip install --upgrade pip pip-tools \
 && pip-compile requirements_vllm.in -o requirements_vllm.txt \
    --unsafe-package torch \
    --unsafe-package torchaudio \
    --unsafe-package torchvision \
 && pip install --no-cache-dir -r requirements_vllm.txt

# Copy the rest of the app
COPY . /app

# -----------------------------
# 5) Expose SSH port
# -----------------------------
EXPOSE 22

# -----------------------------
# 6) Start SSHD (keep container alive)
# -----------------------------
CMD ["/usr/sbin/sshd", "-D"]
