FROM nvidia/cuda:12.9.0-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install Python 3.11 (required by perception-models/sam_audio)
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
  && add-apt-repository -y ppa:deadsnakes/ppa \
  && apt-get update && apt-get install -y --no-install-recommends \
    openssh-server \
    ffmpeg \
    ca-certificates \
    git \
    python3.11 \
    python3.11-venv \
    python3.11-dev \
    python3.11-distutils \
    gcc \
    g++ \
    ninja-build \
    curl \
  && rm -rf /var/lib/apt/lists/* \
  && ln -sf /usr/bin/python3.11 /usr/bin/python3 \
  && ln -sf /usr/bin/python3.11 /usr/bin/python \
  && curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11

# -----------------------------
# Install PyTorch + vLLM nightly (CUDA 12.9 wheels)
# -----------------------------
RUN pip install --upgrade pip

# Install PyTorch with CUDA 12.9 support
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu129

# Install Flash Attention 2 (requires compilation for torch 2.9 + CUDA 12.9)
# MAX_JOBS=1 - limits parallel compilation jobs
# NVCC_THREADS=1 - limits nvcc internal parallelism
# TORCH_CUDA_ARCH_LIST=9.0 - compile only for H100 (drastically reduces memory + time)
RUN pip install packaging ninja psutil \
 && MAX_JOBS=2 NVCC_THREADS=1 TORCH_CUDA_ARCH_LIST="9.0" \
    pip install flash-attn --no-build-isolation

# Install vLLM nightly with CUDA 12.9 prebuilt wheels (no compilation needed)
RUN pip install vllm --extra-index-url https://wheels.vllm.ai/nightly/cu129

# -----------------------------
# Install sam_audio dependencies (git-based, can't go in requirements.in)
# -----------------------------
# perception-models provides the 'core' module (audio_visual_encoder, vision_encoder, etc.)
RUN pip install "perception-models @ git+https://github.com/facebookresearch/perception_models@unpin-deps"

# Other sam_audio git dependencies
RUN pip install "dacvae @ git+https://github.com/facebookresearch/dacvae.git" \
 && pip install "imagebind @ git+https://github.com/facebookresearch/ImageBind.git" \
 && pip install "laion-clap @ git+https://github.com/lematt1991/CLAP.git"

WORKDIR /app

# Copy requirements first (better layer caching)
COPY src/pipelines/instrument_detection/requirements_vllm.in /app/requirements_vllm.in

# Compile requirements, strip already-installed packages, install rest
RUN pip install pip-tools \
 && pip freeze | grep -E "^(torch|torchaudio|torchvision)==" > /tmp/torch-constraints.txt \
 && pip-compile requirements_vllm.in -o requirements_vllm.txt \
 && grep -vE "^(nvidia-|torch==|torchaudio==|torchvision==|triton==|sympy==|vllm==|flash-attn==|perception-models|dacvae|imagebind|laion-clap)" requirements_vllm.txt > requirements_vllm-clean.txt \
 && pip install --no-cache-dir -r requirements_vllm-clean.txt -c /tmp/torch-constraints.txt

# Copy the rest of the app
COPY . /app

CMD ["tail", "-f", "/dev/null"]
